# fname <- "./inst/extdata/center_line.gpkg"
center_line <- sf::st_read(fname)
plot(sf::st_geometry(center_line), col = "red")
# plot(sf::st_geometry(center_line), col = "red")
# Drop duplicates for HUC_ID
center_line <- center_line[!duplicated(center_line$HUC_ID), ]
# Drop duplicate geometries
center_line <- center_line[!duplicated(sf::st_as_text(sf::st_geometry(center_line))), ]
center_line$id <- 1:nrow(center_line)
center_line$id <- 1:nrow(center_line)
plot(sf::st_geometry(center_line), add = TRUE)
# Sample points along line
pol <- suppressWarnings({
points_on_line(center_line,
point_spacing = 100)
})
# Stream Lines
fname <-
system.file("extdata", "ndss_critical_reaches.gpkg", package = "streamgis")
# fname <- "./inst/extdata/center_line.gpkg"
center_line <- sf::st_read(fname)
# plot(sf::st_geometry(center_line), col = "red")
# Drop duplicates for HUC_ID
center_line <- center_line[!duplicated(center_line$HUC_ID), ]
# Drop duplicate geometries
center_line <- center_line[!duplicated(sf::st_as_text(sf::st_geometry(center_line))), ]
# Drop emty geometires
center_line <- center_line[!sf::st_is_empty(center_line), ]
center_line$id <- 1:nrow(center_line)
# Sample points along line
pol <- suppressWarnings({
points_on_line(center_line,
point_spacing = 100)
})
center_line$length_m <- as.numeric(sf::st_length(center_line))
center_line$length_m
summary(center_line$length_m)
points_on_line(center_line,
point_spacing = 50)
point_spacing = 50
epsg = 26910
reverse_coordinates = FALSE
if (is.na(center_line)[1] || !inherits(center_line, "sf")) {
stop("`center_line` must be an sf object (LINESTRING/MULTILINESTRING) with an `id` column.")
}
if (!"id" %in% names(center_line)) {
stop("`center_line` must have an `id` column.")
}
if (nrow(center_line) < 1) stop("Center line is empty.")
if (!is.numeric(point_spacing) || point_spacing <= 0) {
stop("`point_spacing` must be a positive number (meters).")
}
if (epsg == 26910) {
message("Assigning EPSG:26910 (UTM zone 10N) for input data.")
}
# set (not transform) CRS if missing/unknown
if (is.na(sf::st_crs(center_line))) {
center_line <- sf::st_set_crs(center_line, epsg)
}
all_points <- vector("list", nrow(center_line))
for (j in seq_len(nrow(center_line))) {
line <- center_line[j, ]
line <- suppressWarnings(sf::st_cast(line, "LINESTRING"))
if (reverse_coordinates) {
line <- sf::st_reverse(line)
}
segment_length <- as.numeric(sf::st_length(line))
if (point_spacing > segment_length) {
# single segment: just start & end
crds  <- sf::st_coordinates(line)
crds  <- as.data.frame(crds)
mdist <- segment_length
x_set <- crds$X[c(1, nrow(crds))]
y_set <- crds$Y[c(1, nrow(crds))]
add_pt <- data.frame(
l_id       = line$id,
p_id       = c(1, 2),
group      = c("start", "end"),
distance_m = c(0, mdist),
X          = x_set,
Y          = y_set
)
all_points[[j]] <- add_pt
warning("Point spacing is longer than line segment length; created only start/end points.")
next
}
# regular interior samples
d_int    <- segment_length / point_spacing
max_int  <- floor(d_int)
max_dist <- max_int * point_spacing
p_dists  <- if (max_dist >= point_spacing) seq(point_spacing, max_dist, by = point_spacing) else numeric(0)
# positions along [0, 1]
frac <- if (length(p_dists)) p_dists / segment_length else numeric(0)
frac <- if (length(frac)) pmax(0, pmin(1, frac)) else numeric(0)
p_on_line <- if (length(frac)) sf::st_line_sample(line, sample = frac) else sf::st_sfc(crs = sf::st_crs(line))
p_on_line <- if (length(frac)) sf::st_cast(p_on_line, "POINT") else p_on_line
# start/end coords
coords <- sf::st_coordinates(line)
coords <- as.data.frame(coords)
check_1 <- unique(coords$L1)
check_2 <- unique(coords$L2)
if (!identical(check_1, 1)) stop("Unhandled MULTILINESTRING structure (L1 != 1).")
if (length(check_2) > 0 && !identical(check_2, 1)) stop("Unhandled MULTILINESTRING structure (L2 != 1).")
coords_start <- stats::setNames(as.data.frame(coords[1, 1:2]), c("X", "Y"))
coords_end   <- stats::setNames(as.data.frame(coords[nrow(coords), 1:2]), c("X", "Y"))
coords_start$group <- "start"
coords_end$group   <- "end"
coord_samp <- if (length(frac)) {
cs <- as.data.frame(sf::st_coordinates(p_on_line))[, 1:2]
names(cs) <- c("X", "Y"); cs$group <- "sample"; cs
} else {
stats::setNames(data.frame(X = numeric(0), Y = numeric(0), group = character(0)),
c("X", "Y", "group"))
}
coord_all <- rbind(coords_start, coord_samp, coords_end)
# helper: project each point onto line to measure distance from origin
gproject_planar <- function(line_ls, pts) {
M      <- sf::st_coordinates(line_ls)[, 1:2, drop = FALSE]
segvec <- M[-1, , drop = FALSE] - M[-nrow(M), , drop = FALSE]
seglen <- sqrt(rowSums(segvec^2))
cum0   <- c(0, cumsum(seglen))
vapply(sf::st_geometry(pts), function(pt) {
p <- sf::st_coordinates(pt)
num <- rowSums((matrix(p, nrow(segvec), 2, byrow = TRUE) - M[-nrow(M), ]) * segvec)
den <- rowSums(segvec^2)
t   <- pmax(0, pmin(1, num / den))
proj <- M[-nrow(M), ] + segvec * t
d2   <- rowSums((proj - matrix(p, nrow(proj), 2, byrow = TRUE))^2)
k    <- which.min(d2)
cum0[k] + t[k] * seglen[k]
}, numeric(1))
}
ca_sf <- sf::st_as_sf(coord_all, coords = c("X", "Y"), crs = sf::st_crs(line))
m_distances <- gproject_planar(line_ls = line, pts = ca_sf)
m_distances <- round(m_distances, 2)
coord_all$distance_m <- m_distances
# light sanity check if enough points
if (nrow(coord_all) > 5 && any(coord_all$group == "sample")) {
samp_idx <- which(coord_all$group == "sample")
if (length(samp_idx) >= 2) {
dist_check <- coord_all$distance_m[samp_idx[2]] - coord_all$distance_m[samp_idx[1]]
diff <- abs(1 - (point_spacing / dist_check))
if (is.finite(diff) && diff > 0.1) {
stop("Large spacing error (>10%). Check CRS/units or geometry validity.")
}
}
}
# ids & order
coord_all$p_id <- seq_len(nrow(coord_all))
coord_all$l_id <- line$id
coord_all <- coord_all[, c("l_id", "p_id", "group", "distance_m", "X", "Y")]
all_points[[j]] <- coord_all
}
j
line <- center_line[j, ]
line <- suppressWarnings(sf::st_cast(line, "LINESTRING"))
if (reverse_coordinates) {
line <- sf::st_reverse(line)
}
segment_length <- as.numeric(sf::st_length(line))
point_spacing
segment_length
plot(st_geometry(line))
center_line
center_line <- sf::st_cast(center_line, "LINESTRING")
center_line
# Drop duplicates for HUC_ID
center_line <- center_line[!duplicated(center_line$HUC_ID), ]
# Drop duplicate geometries
center_line <- center_line[!duplicated(sf::st_as_text(sf::st_geometry(center_line))), ]
# Drop emty geometires
center_line <- center_line[!sf::st_is_empty(center_line), ]
center_line$length_m <- as.numeric(sf::st_length(center_line))
summary(center_line$length_m)
# plot(sf::st_geometry(center_line), add = TRUE)
center_line <- suppressWarnings({ sf::st_cast(center_line, "LINESTRING") })
center_line$id <- 1:nrow(center_line)
# fname <- "./inst/extdata/center_line.gpkg"
center_line <- sf::st_read(fname)
# plot(sf::st_geometry(center_line), col = "red")
# Drop duplicates for HUC_ID
center_line <- center_line[!duplicated(center_line$HUC_ID), ]
# Drop duplicate geometries
center_line <- center_line[!duplicated(sf::st_as_text(sf::st_geometry(center_line))), ]
# Drop emty geometires
center_line <- center_line[!sf::st_is_empty(center_line), ]
center_line$length_m <- as.numeric(sf::st_length(center_line))
summary(center_line$length_m)
# plot(sf::st_geometry(center_line), add = TRUE)
center_line <- suppressWarnings({ sf::st_cast(center_line, "LINESTRING") })
center_line$id <- 1:nrow(center_line)
# Sample points along line
pol <- suppressWarnings({
points_on_line(center_line,
point_spacing = 50)
})
plot(sf::st_geometry(center_line[center_line$id == 3, ]))
plot(sf::st_geometry(pol[pol$l_id == 3, ]), add = TRUE, col = "red")
# Do distances make sense
diff <- pol$distance_m[6] - pol$distance_m[5]
expect_true(round(diff, 0) == 100)
# Do distances make sense
diff <- pol$distance_m[6] - pol$distance_m[5]
expect_true(round(diff, 0) == 50)
# Do points start at origin
expect_true(round(pol$distance_m[2], 0) == 50)
csl <- cross_section_lines(
center_line = center_line,
points = pol,
cross_profile_length = 200,
epsg = 26910
)
plot(sf::st_geometry(center_line[center_line$id == 3, ]))
plot(sf::st_geometry(pol[pol$l_id == 3, ]), add = TRUE, col = "red")
plot(sf::st_geometry(csl[csl$l_id == 3, ]), add = TRUE, col = "blue")
csl <- cross_section_lines(
center_line = center_line,
points = pol,
cross_profile_length = 100,
epsg = 26910
)
st_write(csl, "C:/Users/mattj/Dropbox/Projects/EN2691 CEPopMod/ND SS/demo/csl.gpkg", delete_dsn = TRUE)
st_write(pol, "C:/Users/mattj/Dropbox/Projects/EN2691 CEPopMod/ND SS/demo/pol.gpkg", delete_dsn = TRUE)
# Test that total profile legnth is reasonable
total_length <- as.numeric(round(sum(sf::st_length(csl)), 0))
expect_length <- nrow(pol) * 250
diff <- abs(1 - (total_length / expect_length))
expect_true(diff < 0.1)
plot(sf::st_geometry(center_line[center_line$id == 3, ]))
plot(sf::st_geometry(pol[pol$l_id == 3, ]), add = TRUE, col = "red")
plot(sf::st_geometry(csl[csl$l_id == 3, ]), add = TRUE, col = "blue")
# Test that total profile legnth is reasonable
total_length <- as.numeric(round(sum(sf::st_length(csl)), 0))
expect_length <- nrow(pol) * 100
diff <- abs(1 - (total_length / expect_length))
expect_true(diff < 0.1)
buff <- clean_reach_buffer(
center_line = center_line,
buffer_width = 80,
cross_section_lines = csl,
us_distance_colname = NA,
epsg = 26910
)
center_line
# =============================================
# =============================================
# test  --- clean_reach_buffer
# =============================================
# =============================================
st_crs(csl)
# =============================================
# =============================================
# test  --- clean_reach_buffer
# =============================================
# =============================================
st_crs(csl)$epsg
# =============================================
# =============================================
# test  --- clean_reach_buffer
# =============================================
# =============================================
st_crs(csl)$epsg
st_crs(center_line)$epsg
center_line <- st_transform(center_line, 26910)
buff <- clean_reach_buffer(
center_line = center_line,
buffer_width = 80,
cross_section_lines = csl,
us_distance_colname = NA,
epsg = 26910
)
# =============================================
# =============================================
# test  --- clean_reach_buffer
# =============================================
# =============================================
st_crs(csl)$epsg
st_crs(center_line)$epsg
center_line <- st_transform(center_line, 26910)
buff <- clean_reach_buffer(
center_line = center_line,
buffer_width = 40,
cross_section_lines = csl,
us_distance_colname = NA,
epsg = 26910
)
plot(sf::st_geometry(center_line[center_line$id == 3, ]))
plot(sf::st_geometry(pol[pol$l_id == 3, ]), add = TRUE, col = "red")
plot(sf::st_geometry(csl[csl$l_id == 3, ]), add = TRUE, col = "blue")
plot(sf::st_geometry(buff[buff$l_id == 3, ]), add = TRUE, col = "grey")
plot(sf::st_geometry(csl[csl$l_id == 3, ]), add = TRUE, col = "blue")
library(rvest)
# get html for page and HTTP status code
url <- "https://www.piquenewsmagazine.com/local-news"
page <- read_html(url)
status_code <- httr::status_code(httr::GET(url))
status_code
library(httr2)
library(rvest)
url <- "https://www.piquenewsmagazine.com/local-news"
req <- request(url) |>
req_user_agent("Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36") |>
req_header(
"Accept" = "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
"Accept-Language" = "en-US,en;q=0.9",
"Referer" = "https://www.google.com/",
"Connection" = "keep-alive",
"Upgrade-Insecure-Requests" = "1"
)
library(dplyr)
url <- "https://www.piquenewsmagazine.com/local-news"
req <- request(url) |>
req_user_agent("Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36") |>
req_header(
"Accept" = "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
"Accept-Language" = "en-US,en;q=0.9",
"Referer" = "https://www.google.com/",
"Connection" = "keep-alive",
"Upgrade-Insecure-Requests" = "1"
)
??req_header
library(httr2)
library(rvest)
library(dplyr)
?req_headers
request(url) |>
req_user_agent("Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36")
req <- request(url) |>
req_user_agent("Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36")
req
resp <- req_perform(req)
status_code <- resp_status(resp)
status_code
page <- resp_body_html(resp)
page
page |> html_element("#category-items")
page
library(rvest)
library(dplyr)
? req_headers
url <- "https://www.piquenewsmagazine.com/local-news"
req <- request(url) |>
req_user_agent(
"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36"
) # |>
resp <- req_perform(req)
status_code <- resp_status(resp)
status_code
page <- resp_body_html(resp)
page |> html_element("#category-items")
page
status_code
library(usethis)
library(testthat)
library(rhub)
library(devtools)
library(qpdf)
library(kableExtra)
library(testthat)
# usethis::use_roxygen_md()     # once per package (if not already)
# Loading unfinished package to memory...
rm(list = ls())
devtools::load_all()
devtools::document()
# Stream Lines
fname <-
system.file("extdata", "ndss_critical_reaches.gpkg", package = "streamgis")
# fname <- "./inst/extdata/center_line.gpkg"
center_line <- sf::st_read(fname)
# plot(sf::st_geometry(center_line), col = "red")
# Drop duplicates for HUC_ID
center_line <- center_line[!duplicated(center_line$HUC_ID), ]
# Drop duplicate geometries
center_line <- center_line[!duplicated(sf::st_as_text(sf::st_geometry(center_line))), ]
# Drop emty geometires
center_line <- center_line[!sf::st_is_empty(center_line), ]
center_line$length_m <- as.numeric(sf::st_length(center_line))
summary(center_line$length_m)
# plot(sf::st_geometry(center_line), add = TRUE)
center_line <- suppressWarnings({ sf::st_cast(center_line, "LINESTRING") })
center_line$id <- 1:nrow(center_line)
# Sample points along line
pol <- suppressWarnings({
points_on_line(center_line,
point_spacing = 50)
})
plot(sf::st_geometry(center_line[center_line$id == 3, ]))
plot(sf::st_geometry(pol[pol$l_id == 3, ]), add = TRUE, col = "red")
# Do distances make sense
diff <- pol$distance_m[6] - pol$distance_m[5]
expect_true(round(diff, 0) == 50)
# Do points start at origin
expect_true(round(pol$distance_m[2], 0) == 50)
csl <- cross_section_lines(
center_line = center_line,
points = pol,
cross_profile_length = 100,
epsg = 26910
)
plot(sf::st_geometry(center_line[center_line$id == 3, ]))
plot(sf::st_geometry(pol[pol$l_id == 3, ]), add = TRUE, col = "red")
plot(sf::st_geometry(center_line[center_line$id == 3, ]))
plot(sf::st_geometry(pol[pol$l_id == 3, ]), add = TRUE, col = "red")
plot(sf::st_geometry(csl[csl$l_id == 3, ]), add = TRUE, col = "blue")
# Test that total profile legnth is reasonable
total_length <- as.numeric(round(sum(sf::st_length(csl)), 0))
expect_length <- nrow(pol) * 100
diff <- abs(1 - (total_length / expect_length))
expect_true(diff < 0.1)
csl
# Test that total profile legnth is reasonable
total_length <- as.numeric(round(sum(sf::st_length(csl)), 0))
expect_length <- nrow(pol) * 100
diff <- abs(1 - (total_length / expect_length))
expect_true(diff < 0.1)
# =============================================
# =============================================
# test  --- clean_reach_buffer
# =============================================
# =============================================
st_crs(csl)$epsg
st_crs(center_line)$epsg
# =============================================
# =============================================
# test  --- clean_reach_buffer
# =============================================
# =============================================
st_crs(csl)$epsg
# =============================================
# =============================================
# test  --- clean_reach_buffer
# =============================================
# =============================================
sf::st_crs(csl)$epsg
# =============================================
# =============================================
# test  --- clean_reach_buffer
# =============================================
# =============================================
sf::st_crs(csl)$epsg
sf::st_crs(center_line)$epsg
center_line <- st_transform(center_line, 26910)
center_line <- sf::st_transform(center_line, 26910)
buff <- clean_reach_buffer(
center_line = center_line,
buffer_width = 40,
cross_section_lines = csl,
us_distance_colname = NA,
epsg = 26910
)
plot(sf::st_geometry(center_line[center_line$id == 3, ]))
plot(sf::st_geometry(pol[pol$l_id == 3, ]), add = TRUE, col = "red")
plot(sf::st_geometry(csl[csl$l_id == 3, ]), add = TRUE, col = "blue")
plot(sf::st_geometry(buff[buff$l_id == 3, ]), add = TRUE, col = "grey")
plot(sf::st_geometry(csl[csl$l_id == 3, ]), add = TRUE, col = "blue")
buff <- clean_reach_buffer(
center_line = center_line,
buffer_width = 30,
cross_section_lines = csl,
us_distance_colname = NA,
epsg = 26910
)
plot(sf::st_geometry(center_line[center_line$id == 3, ]))
plot(sf::st_geometry(pol[pol$l_id == 3, ]), add = TRUE, col = "red")
plot(sf::st_geometry(csl[csl$l_id == 3, ]), add = TRUE, col = "blue")
plot(sf::st_geometry(buff[buff$l_id == 3, ]), add = TRUE, col = "grey")
plot(sf::st_geometry(csl[csl$l_id == 3, ]), add = TRUE, col = "blue")
plot(sf::st_geometry(buff[buff$l_id == 3, ]), add = TRUE, col = "grey")
# Test geometry type
test_geom <- as.character(unique(sf::st_geometry_type(buff)))
expect_true(test_geom == "POLYGON")
# Rows populated
expect_true(nrow(buff) > 0)
# Rows less than or equal to cross sections
expect_true(nrow(buff) <= nrow(csl))
# Fix order and test distance field
fix_order <- csl[order(csl$l_id, csl$p_id),]
fix_order$us_distance_m <- cumsum(fix_order$distance_m)
# plot(fix_order['us_distance_m'])
csl <- fix_order
# Add variable length buffer
center_line$my_buffer <- rnorm(nrow(center_line)) * 20
center_line$my_buffer <- abs(center_line$my_buffer)
buff <- clean_reach_buffer(
center_line = center_line,
buffer_width = "my_buffer",
cross_section_lines = csl,
us_distance_colname = 'us_distance_m',
epsg = 26910
)
# Test geometry type
test_geom <- as.character(unique(sf::st_geometry_type(buff)))
expect_true(test_geom == "POLYGON")
# Rows populated
expect_true(nrow(buff) > 0)
# Rows less than or equal to cross sections
expect_true(nrow(buff) <= nrow(csl))
library(usethis)
library(testthat)
library(rhub)
library(devtools)
library(qpdf)
library(kableExtra)
library(testthat)
# usethis::use_roxygen_md()     # once per package (if not already)
# Loading unfinished package to memory...
rm(list = ls())
devtools::load_all()
devtools::document()
devtools::test()  # Run tests - all passed Sept 10 2025
remove.packages("custompackage")
remove.packages("custompackage")
