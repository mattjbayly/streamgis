% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/sample_profiles_and_canopy_angle.R
\name{sample_profiles_and_canopy_angle}
\alias{sample_profiles_and_canopy_angle}
\title{Sample Profiles and Compute Canopy Open Angles}
\usage{
sample_profiles_and_canopy_angle(
  csl,
  raster_path_tree_height = NULL,
  raster_path_terrain = NULL,
  step_m = 1,
  center_distance = 50,
  set_vertical_offset = NULL
)
}
\arguments{
\item{csl}{An \code{sf} data frame of \code{LINESTRING}/\code{MULTILINESTRING}
geometry with columns \code{l_id} and \code{p_id}. Cross sectional lines.
This object should be generated from \code{streamgis::cross_section_lines}}

\item{raster_path_tree_height}{Character path to a raster readable by \pkg{terra}
(tree height or DSM elevation - fine scale digital surface model).}

\item{raster_path_terrain}{Character path to a raster readable by \pkg{terra}
(terrain or DTM elevation - fine scale digital terrain model).}

\item{step_m}{Numeric spacing (meters) between sampled points along each line.
Must be > 0. Default \code{1} for 1m.}

\item{center_distance}{Numeric distance (meters) along each profile at which to
anchor the center point for the angle calculation. Default \code{50} 50m.}
}
\value{
A list with:
\itemize{
\item \code{points}: an \code{sf} POINT layer with columns \code{l_id}, \code{p_id},
\code{uid}, \code{dist_m}, and one column per raster band (e.g., \code{tree_height}).
\item \code{canopy}: a data frame with one row per profile (\code{l_id}, \code{p_id}, \code{uid})
and columns \code{center_dist_m}, \code{center_elev}, \code{left_angle_deg},
\code{right_angle_deg}, and \code{canopy_open_angle_deg}.
}
}
\description{
Sample points at regular spacing along each csl line feature, extract raster values
(e.g., tree height / elevation) at those points, and compute a simple
canopy-open angle per unique \code{(l_id, p_id)} profile based on the first
left/right rise above the center point.
}
\details{
For each csl line, points are generated every \code{step_m} meters from the start
of the geometry to its end (the end is included even when not a multiple of
\code{step_m}). Raster values are extracted at those points. For each profile
(\code{l_id}, \code{p_id}), the center point is chosen as the sample closest
to \code{center_distance}. The first point to the left and right with a value
strictly greater than the center value defines the left/right rays. Angles are
computed as \eqn{\mathrm{atan2}(\Delta y, \Delta x)} in degrees and summed to a
\emph{canopy open angle}.

Inputs must be projected in meters (e.g., UTM). If the raster CRS differs from
the lines CRS, the raster is projected to match the lines.
}
\section{Angle definition}{

Angles are measured from the horizontal using \code{atan2(Δy, Δx)} (degrees).
The left ray goes toward decreasing \code{dist_m}; the right ray toward increasing
\code{dist_m}. If no qualifying point exists on a side, that side's angle is 0.
The canopy open angle measurement is the sum of the left ray and the right ray.
}

\examples{
\dontrun{
library(sf)
library(streamgis)
# Load Stream Lines
fname <-
  system.file("extdata", "./ndss/lidar_strms.gpkg", package = "streamgis")

center_line <- sf::st_read(fname)
# Drop duplicate geometries
center_line <- center_line[!duplicated(sf::st_as_text(sf::st_geometry(center_line))), ]
# Drop emty geometires
center_line <- center_line[!sf::st_is_empty(center_line), ]
center_line$length_m <- as.numeric(sf::st_length(center_line))

summary(center_line$length_m)
# plot(sf::st_geometry(center_line))
center_line <- suppressWarnings({
  sf::st_cast(center_line, "LINESTRING")
})

# Make sure there is an ID field
center_line$id <- 1:nrow(center_line)

# =============================================
# Sample Points Along the Stream
# =============================================

# Sample points along line
pol <- suppressWarnings({
  points_on_line(center_line, point_spacing = 50)
})


dev.off()
plot(sf::st_geometry(center_line[center_line$id == 3, ]))
plot(sf::st_geometry(pol[pol$l_id == 3, ]), add = TRUE, col = "red")


# =============================================
# Create Cross-Sectional Lines
# =============================================

csl <- cross_section_lines(
  center_line = center_line,
  points = pol,
  cross_profile_length = 151,
  epsg = 26910
)


plot(sf::st_geometry(center_line[center_line$id == 12, ]))
plot(sf::st_geometry(pol[pol$l_id == 12, ]), add = TRUE, col = "red")
plot(sf::st_geometry(csl[csl$l_id == 12, ]), add = TRUE, col = "blue")



# =============================================
# Calculate Open Angle
# =============================================

tree_raster_path <- system.file("extdata", "./ndss/gedi_tree_32610.tif", package = "streamgis")

spcoa <- sample_profiles_and_canopy_angle(
  csl = csl,
  raster_path_tree_height = tree_raster_path,
  step_m = 1,
  center_distance = (151 / 2),
  set_vertical_offset = 1.5
)

# Generate sample QA plots
spcoa$points  # sf POINTs: l_id, p_id, uid, dist_m, elevation/tree height
head(spcoa$canopy)  # one row per (l_id, p_id) with canopy_open_angle_deg


# =============================================
# Create Detailed Diagnostic Plots
# =============================================

# See vignette

}
}
